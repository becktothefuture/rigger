# PRD: Rigger Minimal-Trace Mode (Preview-First + Decommission MVP)

## 1. Introduction / Overview
Rigger's core value is real-time experimentation with DOM values. Users should be able to play with typography, spacing, and color live without committing project edits until they explicitly choose to do so. This PRD defines an MVP that separates live preview from persistent writes and introduces a manual decommission flow to remove Rigger-generated artifacts when no longer needed.

This is designed to minimize project trace while preserving Rigger's "fast, tactile tuning" workflow.

**User choices captured:**
- Primary outcome: full "as-if-never-installed" intent where possible.
- Cleanup scope for MVP: generated artifacts only.
- Trigger: manual command.
- Safety: immediate apply with undo support.
- Out of scope: cleanup of non-tagged files and automatic git commit/revert behavior.

## 2. Goals
- Keep live tuning fileless by default: changing controls updates previewed DOM state in real time with no workspace writes.
- Require explicit commit for persistent changes via the main panel action ("Rig it up").
- Preserve safe commit workflow: preview changes before apply, then apply in one undoable step.
- Add `Rigger: Decommission` command that removes Rigger-generated artifacts in one undoable operation.
- Ensure MVP leaves minimal residual trace when users stop using Rigger.

## 3. MVP Definition
MVP is a two-phase interaction model with cleanup support:

1. **Preview phase (ephemeral):**
   - Sliders/inputs update preview DOM in real time.
   - No CSS/source/config files are modified during this phase.
2. **Rig phase (explicit commit):**
   - User clicks the main action button in panel ("Rig it up"/apply).
   - User gets a safe preview of persistent changes.
   - On confirmation, edits are written in one undoable step.
3. **Decommission phase (manual):**
   - User runs `Rigger: Decommission`.
   - Rigger removes generated artifacts it can confidently identify (MVP scope).
   - Operation is one undoable step.

## 4. User Stories

### US-001: Real-time preview without file writes
**Description:** As a designer/developer, I want control changes to update previewed DOM values instantly so I can explore safely without modifying project files.

**Acceptance Criteria:**
- [ ] Slider/input changes update visible preview in under 100ms on local demo targets.
- [ ] No workspace file changes occur while adjusting controls in preview mode.
- [ ] Preview values can be reset to current baseline without re-running scan.
- [ ] Typecheck/lint passes.
- [ ] Verify in browser using dev-browser skill.

### US-002: Explicit "Rig it up" commit gate
**Description:** As a user, I want persistent edits to happen only when I click the main panel action so experimentation remains reversible and low-risk.

**Acceptance Criteria:**
- [ ] No persistent edit APIs run before user clicks the main apply button.
- [ ] Clicking main apply starts the persistent edit workflow from current preview values.
- [ ] The button is disabled when no scan is available.
- [ ] Typecheck/lint passes.
- [ ] Verify in browser using dev-browser skill.

### US-003: Safe persistent preview before apply
**Description:** As a user, I want to preview persistent output safely before applying it to the workspace.

**Acceptance Criteria:**
- [ ] Persistent apply flow opens an explicit preview of the resulting changes.
- [ ] User can cancel from preview and return to editing without file writes.
- [ ] Apply still executes as a single undo step after confirmation.
- [ ] Typecheck/lint passes.

### US-004: Generated artifact cleanup command (MVP)
**Description:** As a user, I want a manual decommission command that removes Rigger-generated artifacts when I no longer need the extension.

**Acceptance Criteria:**
- [ ] `Rigger: Decommission` command is registered and accessible via command palette.
- [ ] Command removes generated artifacts in MVP scope (`rig.config.json`, `rig.snapshot.json`, and any future Rigger-generated files tracked by manifest).
- [ ] Cleanup runs in one undoable workspace edit operation.
- [ ] A result message shows what was removed and what was skipped.
- [ ] Typecheck/lint passes.

### US-005: Decommission report transparency
**Description:** As a user, I want decommission output to clearly explain residual trace so there are no surprises.

**Acceptance Criteria:**
- [ ] Decommission summary includes removed artifacts and remaining trace categories not covered by MVP.
- [ ] Skipped items include explicit reason (e.g., not generated by Rigger, unsupported in MVP).
- [ ] Summary is available in OutputChannel and UI status message.
- [ ] Typecheck/lint passes.

### US-006: Preview/apply regression tests
**Description:** As a developer, I want tests for the new preview-first contract so future changes cannot silently reintroduce unsafe auto-writes.

**Acceptance Criteria:**
- [ ] Unit test verifies preview updates do not call persistent edit functions.
- [ ] Unit test verifies apply flow writes only after explicit action.
- [ ] Unit test verifies decommission removes only generated artifacts in scope.
- [ ] Existing integration tests continue to pass.
- [ ] Typecheck/lint passes.

## 5. Functional Requirements
- FR-1: Control adjustments must update previewed DOM values in real time without writing workspace files.
- FR-2: Persistent edits must only be initiated by explicit user action on the main panel apply control.
- FR-3: Apply flow must provide a persistent-change preview before final confirmation.
- FR-4: Confirmed apply must execute all writes in one workspace undo step.
- FR-5: Extension must expose command `rigger.decommission` (`Rigger: Decommission`).
- FR-6: Decommission must remove only artifacts that Rigger can identify as generated by itself (MVP scope: generated files).
- FR-7: Decommission must provide a machine-readable and human-readable summary of removed/skipped artifacts.
- FR-8: Logs must include preview start, apply confirm/cancel, and decommission results.
- FR-9: Existing scan and "Rig it up" flows must remain backward compatible for users who choose immediate apply.

## 6. Non-Goals (Out of Scope)
- Removing or rewriting non-tagged project files.
- Automatic git commit, revert, or branch manipulation.
- Automatic cleanup on uninstall/disable (manual command is the only MVP trigger).
- Cross-machine/global cleanup of user/environment settings.

## 7. Design Considerations
- Keep panel mental model explicit with two states: `Preview` and `Applied`.
- Main action should communicate commitment clearly (for example: "Rig into Project").
- Show lightweight, always-visible hint: "Preview is safe; no files changed yet."
- Decommission affordance should be discoverable but separated from day-to-day rig controls.

## 8. Technical Considerations
- Introduce a preview channel that updates target DOM via runtime overrides instead of file rewrites.
- Keep persistent write path isolated and callable only from explicit apply actions.
- Add artifact ownership tracking for generated files (manifest or deterministic naming rules).
- Preserve WorkspaceEdit usage for undo integrity on both apply and decommission.
- Maintain strict CSP and avoid introducing remote injection risk in preview transport.

## 9. Risks / Compatibility Notes
- **Security risk:** DOM preview transport could become an injection surface if values are not sanitized.
- **Performance risk:** high-frequency slider updates can cause jank on large pages; must throttle/debounce rendering pipeline.
- **Backward compatibility risk:** users relying on current auto-write behavior may need migration messaging when preview-first mode ships.
- **Product risk:** MVP decommission scope excludes non-generated traces; users may expect deeper cleanup than provided.

## 10. Success Metrics
- 0 unintended workspace writes during preview interactions.
- 100% of persistent writes gated by explicit apply action.
- Decommission command removes all in-scope generated artifacts in a single operation.
- Median time from slider movement to visible preview update under 100ms on demo workspace.
- No regression in existing unit/integration test pass rates.

## 11. End-to-End Flow (Beginning to End)
1. User opens Rigger panel and scans project.
2. User tweaks controls; preview updates DOM instantly, no file writes occur.
3. User decides to commit and clicks main panel button.
4. Rigger shows persistent-change preview.
5. User confirms; Rigger writes persistent edits in one undoable step.
6. Later, user no longer needs Rigger and runs `Rigger: Decommission`.
7. Rigger removes generated artifacts, reports what was removed/skipped, and leaves minimal MVP trace.

## 12. Open Questions
- Should MVP decommission also remove marker blocks inside source CSS when they are fully machine-identifiable as Rigger-generated?
- Should decommission be callable from an in-panel button in addition to command palette?
- Should preview-first behavior be default-on for existing users, or opt-in behind a setting for one release cycle?
